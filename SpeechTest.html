<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <title>浏览器内置语音转文字示例</title>
    <!-- 引入Bootstrap CSS -->
    <link href="./css/bootstrap.min.css" rel="stylesheet">
    <!-- 引入Alpine.js -->
    <script src="./js/alpine.min.js" defer></script>
    <!-- 引入Bootstrap JS -->
    <script src="./js/bootstrap.min.js"></script>

    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 40px 0;
            background-color: #f0f2f5;
        }

        .btn-custom {
            width: 150px;
        }

        pre {
            background: #ffffff;
            padding: 15px;
            border-radius: 6px;
            text-align: left;
            white-space: pre-wrap;
            word-wrap: break-word;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            max-height: 300px;
            overflow-y: auto;
            margin: 20px 0;
        }

        /* 增强按钮的视觉效果 */
        .start-btn:hover {
            background-color: #45a049;
        }

        .stop-btn:hover {
            background-color: #e53935;
        }

        /* 状态指示圆点样式 */
        .indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .listening {
            background-color: #4caf50;
        }

        .not-listening {
            background-color: #f44336;
        }

        .transcribing {
            background-color: #2196f3;
        }

        .not-transcribing {
            background-color: #9e9e9e;
        }

        /* Spinner样式 */
        .spinner-border {
            width: 20px;
            height: 20px;
        }
    </style>
</head>

<body x-data="speechRecognition()" x-init="init()">
    <div class="container">
        <h1 class="mb-4">浏览器内置语音转文字示例</h1>

        <!-- 转录控制按钮 -->
        <div class="d-flex justify-content-center mb-4">
            <button :disabled="isTranscribing" @click="startTranscription" class="btn btn-success btn-custom me-3">
                开始转录
            </button>
            <button :disabled="!isTranscribing" @click="stopTranscription" class="btn btn-danger btn-custom">
                停止转录
            </button>
        </div>

        <!-- 状态指示 -->
        <div class="row justify-content-center mb-4">
            <div class="col-md-6">
                <div class="card p-3">
                    <div class="d-flex align-items-center mb-3">
                        <span :class="isRecognizing ? 'indicator listening' : 'indicator not-listening'"></span>
                        <strong x-text="isRecognizing ? '麦克风正在监听' : '麦克风未监听'"></strong>
                        <template x-if="isStarting">
                            <div class="spinner-border text-primary ms-3" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                        </template>
                    </div>
                    <div class="d-flex align-items-center">
                        <span :class="isTranscribing ? 'indicator transcribing' : 'indicator not-transcribing'"></span>
                        <strong x-text="isTranscribing ? '语音转文字中' : '语音转文字已停止'"></strong>
                        <template x-if="isProcessing">
                            <div class="spinner-border text-primary ms-3" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                        </template>
                    </div>
                </div>
            </div>
        </div>

        <!-- 实时显示内容 -->
        <div class="row justify-content-center">
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        实时显示内容
                    </div>
                    <div class="card-body">
                        <pre x-text="displayContent"></pre>
                    </div>
                </div>
            </div>
        </div>

        <!-- 格式化的 JSON 数据 -->
        <div class="row justify-content-center mt-4">
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header bg-secondary text-white">
                        格式化的 JSON 数据
                    </div>
                    <div class="card-body">
                        <pre x-text="formattedSpeechContent()"></pre>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        function speechRecognition() {
            return {
                // 状态标志
                isRecognizing: false, // 麦克风监听状态
                isTranscribing: false, // 语音转文字处理状态
                isProcessing: false, // 正在处理转录内容
                recognition: null, // SpeechRecognition实例
                displayContent: "", // 实时显示内容
                completedSpeechContent: { paragraphs: [] }, // 已完成的语音内容
                currentSpeechTranscript: "", // 当前临时句子
                totalSentenceCount: 0, // 已完成句子总数
                restartAttempts: 0, // 重启尝试次数
                maxRestartAttempts: 10, // 最大重启次数
                restartDelay: 3000, // 重启延迟（毫秒）
                heartbeatInterval: null, // 心跳定时器
                isStarting: false, // 标志：识别正在启动

                // 初始化函数
                init() {
                    // 初始化 Web Speech API
                    window.SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition || null;

                    if (!window.SpeechRecognition) {
                        this.showAlert('您的浏览器不支持语音识别。请使用最新版本的 Chrome 或 Edge。', 'danger');
                        return;
                    }

                    this.recognition = new window.SpeechRecognition();
                    this.recognition.lang = 'zh-CN';
                    this.recognition.interimResults = true;
                    this.recognition.continuous = true;

                    // 识别开始事件
                    this.recognition.onstart = () => {
                        console.log('语音识别已启动。');
                        this.isRecognizing = true;
                        this.isStarting = false; // 识别已成功启动
                        this.restartAttempts = 0; // 重启次数重置
                    };

                    // 识别错误事件
                    this.recognition.onerror = (event) => {
                        console.error('语音识别错误:', event.error);
                        // 根据错误类型采取不同策略
                        if (event.error === 'not-allowed' || event.error === 'service-not-allowed') {
                            this.showAlert('语音识别权限被拒绝。请允许访问麦克风。', 'danger');
                            this.isRecognizing = false;
                            this.isTranscribing = false;
                        } else {
                            this.showAlert(`语音识别错误: ${event.error}`, 'warning');
                            this.isRecognizing = false;
                            this.isTranscribing = false;
                            this.handleRecognitionEnd();
                        }
                        this.isStarting = false; // 识别启动失败
                    };

                    // 识别结束事件
                    this.recognition.onend = () => {
                        console.log('语音识别已结束。');
                        this.isRecognizing = false;
                        this.isTranscribing = false;
                        this.handleRecognitionEnd();
                        this.isStarting = false; // 确保标志重置
                    };

                    // 识别结果事件
                    this.recognition.onresult = (event) => {
                        if (!this.isTranscribing) {
                            // 如果未开启转录，忽略结果
                            return;
                        }

                        this.isProcessing = true;

                        for (let i = event.resultIndex; i < event.results.length; i++) {
                            const result = event.results[i];
                            const transcript = result[0].transcript.trim();
                            const isFinal = result.isFinal;

                            if (isFinal) {
                                this.pushCompletedSpeechContent(transcript);
                                this.currentSpeechTranscript = "";
                            } else {
                                // 更新当前临时句子
                                this.currentSpeechTranscript = transcript;
                            }
                        }

                        // 更新 displayContent
                        this.flushDisplaycontent();
                    };

                    // 自动启动录音
                    this.startRecognition();
                },

                // 将完成的转录内容添加到completedSpeechContent
                pushCompletedSpeechContent(finalTranscript) {
                    // 计算段落索引，每10个句子为一个段落
                    const paragraphIndex = Math.floor(this.totalSentenceCount / 10);
                    // 计算句子索引，0-9
                    const sentenceIndex = this.totalSentenceCount % 10;

                    // 检查是否需要添加新的段落到 completedSpeechContent
                    if (!this.completedSpeechContent.paragraphs[paragraphIndex]) {
                        // 使用直接赋值确保段落在正确的位置
                        this.completedSpeechContent.paragraphs[paragraphIndex] = {
                            sentences: [],
                            isChecked: false
                        };
                    }

                    console.log(this.completedSpeechContent);

                    const currentCompletedParagraph = this.completedSpeechContent.paragraphs[paragraphIndex];

                    console.log(currentCompletedParagraph);

                    // 确保 sentences 数组有足够的长度（10个句子）
                    while (currentCompletedParagraph.sentences.length < 10) {
                        currentCompletedParagraph.sentences.push({});
                    }

                    // 使用 splice 确保 Alpine.js 能检测到数组变化
                    currentCompletedParagraph.sentences.splice(sentenceIndex, 1, {
                        finalTranscript: finalTranscript
                    });

                    this.totalSentenceCount += 1;
                },

                // 处理识别结束事件
                handleRecognitionEnd() {
                    // 仅在识别未被用户手动停止时尝试重启
                    if (!this.isRecognizing && this.isTranscribing) {
                        // 识别已经停止且不是用户手动停止
                        if (this.restartAttempts < this.maxRestartAttempts) {
                            this.restartAttempts++;
                            console.log(`尝试重启语音识别 (${this.restartAttempts}/${this.maxRestartAttempts}) in ${this.restartDelay / 1000}秒...`);
                            setTimeout(() => {
                                this.startRecognition();
                            }, this.restartDelay);
                        } else {
                            console.warn('达到最大重启次数，语音识别停止。');
                            this.showAlert('语音识别已停止。请手动重新启动。', 'warning');
                        }
                    }
                },

                // 开始转录
                startTranscription() {
                    if (!this.isTranscribing) {
                        this.isTranscribing = true;
                        console.log('开始转录语音...');
                        this.showAlert('语音转文字已开始。', 'success');
                        // 更新显示状态
                        this.flushDisplaycontent();
                    }
                },

                // 停止转录
                stopTranscription() {
                    if (this.isTranscribing) {
                        this.isTranscribing = false;
                        console.log('停止转录语音...');
                        this.showAlert('语音转文字已停止。', 'info');
                        // 更新显示状态
                        if (this.currentSpeechTranscript) {
                            this.pushCompletedSpeechContent(this.currentSpeechTranscript);
                            this.currentSpeechTranscript = "";
                            this.flushDisplaycontent();
                        }
                    }
                },

                // 启动语音识别
                startRecognition() {
                    if (this.recognition && !this.isRecognizing && !this.isStarting) {
                        try {
                            this.isStarting = true; // 标记识别正在启动
                            this.recognition.start(); // 开始录音会话
                            this.startHeartbeat(); // 启动心跳机制
                            console.log('启动语音识别...');
                        } catch (error) {
                            this.isStarting = false; // 识别启动失败
                            console.error('启动语音识别失败:', error);
                            this.showAlert('启动语音识别失败，请重试。', 'danger');
                        }
                    }
                },

                // 停止语音识别
                stopRecognition() {
                    if (this.recognition && this.isRecognizing) {
                        try {
                            this.isRecognizing = false; // 更新状态为未监听
                            this.isTranscribing = false; // 停止转录
                            this.stopHeartbeat(); // 停止心跳机制
                            this.recognition.abort(); // 终止当前的录音会话
                            // 如果有临时转录内容，手动添加到已完成内容
                            if (this.currentSpeechTranscript) {
                                this.pushCompletedSpeechContent(this.currentSpeechTranscript);
                                this.currentSpeechTranscript = "";
                                this.flushDisplaycontent();
                            }
                            console.log('停止语音识别。');
                        } catch (error) {
                            console.error('停止语音识别失败:', error);
                            this.showAlert('停止语音识别失败，请重试。', 'danger');
                        }
                    }
                },

                // 更新显示内容
                flushDisplaycontent() {
                    let content = "";
                    // 添加已完成的内容
                    this.completedSpeechContent.paragraphs.forEach(paragraph => {
                        paragraph.sentences.forEach(sentence => {
                            if (sentence.finalTranscript) {
                                content += sentence.finalTranscript + " ";
                            }
                        });
                        content += "\n"; // 每个段落换行
                    });
                    // 添加当前临时句子
                    if (this.isTranscribing && this.currentSpeechTranscript) {
                        content += this.currentSpeechTranscript + " ";
                    }
                    this.displayContent = content.trim();
                },

                // 简单格式化JSON内容
                formattedSpeechContent() {
                    try {
                        return JSON.stringify(this.completedSpeechContent, null, 2);
                    } catch (error) {
                        console.error('格式化 JSON 失败:', error);
                        return '格式化 JSON 失败';
                    }
                },

                // 心跳机制：定期检查识别状态
                startHeartbeat() {
                    if (this.heartbeatInterval) return; // 防止多次创建定时器
                    this.heartbeatInterval = setInterval(() => {
                        if (!this.isRecognizing && this.isTranscribing && this.restartAttempts < this.maxRestartAttempts) {
                            console.log('心跳检测：语音识别未运行，尝试重启。');
                            this.startRecognition();
                        }
                    }, 5000); // 每5秒检查一次
                },

                // 停止心跳机制
                stopHeartbeat() {
                    if (this.heartbeatInterval) {
                        clearInterval(this.heartbeatInterval);
                        this.heartbeatInterval = null;
                    }
                },

                // 显示Bootstrap Alert
                showAlert(message, type) {
                    // 创建一个临时Alert元素
                    const alertContainer = document.createElement('div');
                    alertContainer.className = `alert alert-${type} alert-dismissible fade show position-fixed top-0 end-0 m-3`;
                    alertContainer.setAttribute('role', 'alert');
                    alertContainer.innerHTML = `
                        ${message}
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    `;
                    document.body.appendChild(alertContainer);

                    // 自动移除Alert after 5 seconds
                    setTimeout(() => {
                        const alert = bootstrap.Alert.getOrCreateInstance(alertContainer);
                        alert.close();
                    }, 5000);
                }
            };
        }
    </script>
</body>

</html>